/**
 * Filename: cashier.controller.billingCashier.js
 * Generated 2018-05-23 at 08:14:45 PM
 */
Ext.define('ExtApp.modules.cashier.controller.billingCashier',{extend:'ExtApp.core.Module',id:'modules.cashier.billingCashier',isloadModuleStore:true,suspendIfLoadStore:true,CURR_BILL_DATA:{},cancelOrder_spv_valid:0,cancelOrder_keterangan:0,save_progress_orderProduct:false,save_progress_orderProduct_split:false,save_progress_splitBill:false,init:function(){this.launcher={text:'Cashier',iconCls:'icon-grid'};},useHelper:['supervisor'],ModuleStore:{'master_pos':[{store_name:'store_productCategory',autoload:false},{store_name:'store_masterSales',autoload:false},{store_name:'store_masterCustomer',autoload:false},{store_name:'store_masterBank',autoload:false},{store_name:'store_masterFloorplan',autoload:false},{store_name:'store_masterTable',autoload:true},{store_name:'store_masterTableInv',autoload:true},{store_name:'store_masterPrinter',autoload:false},{store_name:'store_printerTipe',autoload:false},{store_name:'store_printerPIN',autoload:false},{store_name:'store_discountPlanner',autoload:false},{store_name:'store_productVarian',autoload:false}],'cashier':[{store_name:'store_masterProductCashier',autoload:false},],'billing':[{store_name:'store_get_dataBilling',autoload:false},{store_name:'store_dataBilling',autoload:false},{store_name:'store_billingDetail',autoload:false},{store_name:'store_billingDetail_split',autoload:false},{store_name:'store_billingDetail_discount',autoload:false},{store_name:'store_billingDetail_compliment',autoload:false}]},ModuleModel:{'master_pos':[{model_name:'model_productCategory'},{model_name:'model_masterSales'},{model_name:'model_masterCustomer'},{model_name:'model_masterBank'},{model_name:'model_masterFloorplan'},{model_name:'model_masterTable'},{model_name:'model_masterTableInv'},{model_name:'model_discountPlanner'},{model_name:'model_productVarian'},{model_name:'model_masterPrinter'}],'cashier':[{model_name:'model_masterProductCashier'},],'billing':[{model_name:'model_dataBilling'},{model_name:'model_get_dataBilling'},{model_name:'model_billingDetail'},{model_name:'model_billingDetail_split'},{model_name:'model_billingDetail_discount'},{model_name:'model_billingDetail_compliment'}]},createWindow:function(me,winID,winFunc){var me=this;var win_func='openWindow';if(winFunc){win_func=winFunc;}
var win_id=me.id;if(winID){win_id=me.id+'_'+winID;if(!winFunc){win_func=winID;}}
var desktop=me.app.getDesktop();var win=me.app.getDesktop().getWindow(win_id);if(!win){me.app.createView('ExtApp.modules.cashier.view.billingCashier',me,win_func);}else{me.app.desktop.restoreWindow(win);}},doClose:function(winVar){var me=this;var win=me.app.getDesktop().getWindow(winVar);if(win){win.doClose();}},showListBilling:function(is_skip){var me=this;if(me.showListBilling_toggle==0){me.showListBilling_toggle=1;Ext.getCmp('billingCashier_listBillingToggleButton').setText('LIST<br/>MENU');Ext.getCmp('billingCashier_listBilling').show();Ext.getCmp('billingCashier_ProductList_area').hide();Ext.getCmp('rightCashierCategory').hide();Ext.getCmp('billingCashier_refreshMenuButton').hide();Ext.getCmp('billingCashier_logoutButton').hide();Ext.getCmp('billingCashier_SettingPrinter').hide();Ext.getCmp('billingCashier_printSettlement').hide();if(ExtApp.asCashier==1){Ext.getCmp('billingCashier_MergeBill').show();Ext.getCmp('billingCashier_unMergeBill').show();Ext.getCmp('billingCashier_SplitBill').show();}else{Ext.getCmp('billingCashier_MergeBill').hide();Ext.getCmp('billingCashier_unMergeBill').hide();Ext.getCmp('billingCashier_SplitBill').hide();}
if(is_skip!=1){var itemTab=Ext.getCmp("billingCashier_listBilling").getActiveTab();if(itemTab.id=='tab_billingCashier_activeBilling'){Ext.getCmp('grid_billingCashier_activeBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_activeBilling').getSelectionModel().select(0);}
if(itemTab.id=='tab_billingCashier_holdBilling'){Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().select(0);}
if(itemTab.id=='tab_billingCashier_paidBilling'){Ext.getCmp('grid_billingCashier_paidBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_paidBilling').getSelectionModel().select(0);}}}else{me.showListBilling_toggle=0;Ext.getCmp('billingCashier_listBillingToggleButton').setText('LIST<br/>BILLING');Ext.getCmp('billingCashier_listBilling').hide();Ext.getCmp('billingCashier_MergeBill').hide();Ext.getCmp('billingCashier_unMergeBill').hide();Ext.getCmp('billingCashier_SplitBill').hide();Ext.getCmp('billingCashier_ProductList_area').show();Ext.getCmp('rightCashierCategory').show();Ext.getCmp('billingCashier_refreshMenuButton').show();Ext.getCmp('billingCashier_logoutButton').show();Ext.getCmp('billingCashier_SettingPrinter').show();Ext.getCmp('billingCashier_printSettlement').show();Ext.getCmp('rightPanelCashier').focus();}},showSearchMenu:function(){if(Ext.getCmp("billingCashier_ProductList_ToolbarSearch").isHidden()==true){Ext.getCmp("billingCashier_ProductList_ToolbarSearch").show();Ext.getCmp("billingCashier_ProductList_ToolbarSearch_searchName").focus();}else{Ext.getCmp("billingCashier_ProductList_ToolbarSearch").hide();Ext.getCmp("rightPanelCashier").focus();}},doSearchMenu:function(){var queryName=Ext.getCmp("billingCashier_ProductList_ToolbarSearch_searchName").getValue();var store=Ext.getCmp('billingCashier_ProductList').store,view=Ext.getCmp('billingCashier_ProductList'),selModel=view.getSelectionModel(),selection=selModel.getSelection()[0];store.suspendEvents();store.clearFilter();store.filter({property:'product_name',anyMatch:true,value:queryName});store.resumeEvents();if(selection&&store.indexOf(selection)===-1){selModel.clearSelections();}
view.refresh();},doSearchTable:function(){var queryName=Ext.getCmp("billingCashier_dataViewTable_ToolbarSearch_searchName").getValue();var store=Ext.getCmp('billingCashier_dataViewTable').store,view=Ext.getCmp('billingCashier_dataViewTable'),selModel=view.getSelectionModel(),selection=selModel.getSelection()[0];store.suspendEvents();store.clearFilter();store.filter({property:'table_no',anyMatch:true,value:queryName});store.resumeEvents();if(selection&&store.indexOf(selection)===-1){selModel.clearSelections();}
view.refresh();},confirmCreateNewBilling:function(){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();var getbilling_id=formBilling.findField('billing_id').getValue();var getbilling_no=formBilling.findField('billing_no').getValue();if(me.CURR_BILL_DATA.billing_status=='paid'){me.doCreateNewBilling();}else{if(getbilling_no!=''){ExtApp.Msg.confirm('Current Billing: #'+getbilling_no+' still Open, Want to Hold this Billing?<br/>If not Hold Billing, Please Use Cancel Billing',false,function(btn){if(btn=='yes'){me.doCreateNewBilling();}else{return false;}});}else{me.doCreateNewBilling();}}},loadGridbillingTab:function(){if(Ext.getCmp("billingCashier_listBilling").isHidden()==false){var itemTab=Ext.getCmp("billingCashier_listBilling").getActiveTab();if(itemTab.id=='tab_billingCashier_activeBilling'){Ext.getCmp("grid_billingCashier_activeBilling").store.load({callback:function(){Ext.getCmp('grid_billingCashier_activeBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_activeBilling').getSelectionModel().select(0);}});}
if(itemTab.id=='tab_billingCashier_holdBilling'){Ext.getCmp("grid_billingCashier_holdBilling").store.load({callback:function(){Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().select(0);}});}
if(itemTab.id=='tab_billingCashier_paidBilling'){Ext.getCmp("grid_billingCashier_paidBilling").store.load({callback:function(){Ext.getCmp('grid_billingCashier_paidBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_paidBilling').getSelectionModel().select(0);}});}}else{}},loadGridActiveBilling:function(){if(Ext.getCmp("billingCashier_listBilling").isHidden()==false){var itemTab=Ext.getCmp("billingCashier_listBilling").getActiveTab();if(itemTab.id=='tab_billingCashier_activeBilling'){Ext.getCmp("grid_billingCashier_activeBilling").store.load({callback:function(){Ext.getCmp('grid_billingCashier_activeBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_activeBilling').getSelectionModel().select(0);}});}}},loadGridHoldBilling:function(){if(Ext.getCmp("billingCashier_listBilling").isHidden()==false){var itemTab=Ext.getCmp("billingCashier_listBilling").getActiveTab();if(itemTab.id=='tab_billingCashier_holdBilling'){Ext.getCmp("grid_billingCashier_holdBilling").store.load({callback:function(){Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().select(0);}});}}},loadGridPaidBilling:function(){if(Ext.getCmp("billingCashier_listBilling").isHidden()==false){var itemTab=Ext.getCmp("billingCashier_listBilling").getActiveTab();if(itemTab.id=='tab_billingCashier_paidBilling'){Ext.getCmp("grid_billingCashier_paidBilling").store.load({callback:function(){Ext.getCmp('grid_billingCashier_paidBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_paidBilling').getSelectionModel().select(0);}});}}},doCreateNewBilling:function(){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();var getbilling_id=formBilling.findField('billing_id').getValue();var getbilling_no=formBilling.findField('billing_no').getValue();var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail'),{msg:"Creating New Billing..."});myMask.show();Ext.getCmp(me.id+'_newBilling_button').setDisabled(true);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(true);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(true);Ext.getCmp(me.id+'_payBilling_button').setDisabled(true);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);var d=new Date();Ext.Ajax.request({waitMsg:'Saving ...',url:appUrl+'cashier/billingCashier/createNewBilling?_dc='+d.getTime(),method:'POST',params:{hold_billing_id:getbilling_id},success:function(response,options){var rsp=Ext.decode(response.responseText);formBilling.reset();if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;formBilling.findField('billing_id').setValue(rsp.billingData.billing_id);formBilling.findField('billing_no').setValue(rsp.billingData.billing_no);formBilling.findField('billing_status').setValue(rsp.billingData.billing_status);formBilling.findField('billingCashier_billing_no').setValue('#'+rsp.billingData.billing_no);formBilling.findField('billingCashier_billing_datetime').setValue(rsp.billingData.created_datetime);var EmptyData=[];me.store_billingCashierDetail.proxy.extraParams.billing_id=rsp.billingData.billing_id;me.store_billingCashierDetail.loadData(EmptyData);}
if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}
Ext.getCmp("grid_billingCashier_activeBilling").store.load();Ext.getCmp("grid_billingCashier_holdBilling").store.load();myMask.hide();Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp(me.id+'_newBilling_button').setDisabled(false);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(false);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(false);Ext.getCmp(me.id+'_payBilling_button').setDisabled(false);},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},confirmCancelBilling:function(){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();var getbilling_id=formBilling.findField('billing_id').getValue();var getbilling_no=formBilling.findField('billing_no').getValue();var infoIfPaid='';if(me.CURR_BILL_DATA.billing_status=='paid'){infoIfPaid='<br/>This Billing been Paid, Cancel Billing will need Supervisor Access<br/>Pembatalan this paid billing will change status to activate billing (not deleted)';}
if(getbilling_no!=''){ExtApp.Msg.confirm('Cancel Billing: #'+getbilling_no+'?'+infoIfPaid,false,function(btn){if(btn=='yes'){if(me.CURR_BILL_DATA.billing_status=='paid'){me.verifySupervisorLogin('Cancel Billing From Paid Billing');}else{me.createWindow(me,'setCancelBilling');}}else{return false;}});}else{ExtApp.Msg.warning('Error: Billing Not Found!');return false;}},doCancelBilling:function(){var me=this;var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail'),{msg:"Cancel Billing #"+me.cancelBilling_billing_no+"..."});myMask.show();Ext.getCmp(me.id+'_newBilling_button').setDisabled(true);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(true);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(true);Ext.getCmp(me.id+'_payBilling_button').setDisabled(true);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);var d=new Date();Ext.Ajax.request({waitMsg:'Cancel ...',url:appUrl+'cashier/billingCashier/cancelBilling?_dc='+d.getTime(),method:'POST',params:{cancel_billing_id:me.cancelBilling_billing_id,cancel_billing_no:me.cancelBilling_billing_no,cancel_notes:me.cancelBilling_keterangan},success:function(response,options){var rsp=Ext.decode(response.responseText);var getDeliverItem=0;var getDeliverItemId=[];var getDeliverCancelNotes=me.cancelBilling_keterangan;var d=Ext.getCmp('grid_billingCashier_billingDetail').store.getRange(0);if(d.length>0){for(x in d){if(d[x].data.order_status=='done'){getDeliverItem++;getDeliverItemId.push(d[x].data.id);}}}
me.clearBilling();if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}
Ext.getCmp("grid_billingCashier_activeBilling").store.load();Ext.getCmp("grid_billingCashier_holdBilling").store.load();myMask.hide();if(getDeliverItem>0){}},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},doCancelBillingPaid:function(){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();var getbilling_id=formBilling.findField('billing_id').getValue();var getbilling_no=formBilling.findField('billing_no').getValue();var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail'),{msg:"Cancel Billing #"+getbilling_no+"..."});myMask.show();Ext.getCmp(me.id+'_newBilling_button').setDisabled(true);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(true);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(true);Ext.getCmp(me.id+'_payBilling_button').setDisabled(true);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);var d=new Date();Ext.Ajax.request({waitMsg:'Cancel ...',url:appUrl+'cashier/billingCashier/cancelBillingPaid?_dc='+d.getTime(),method:'POST',params:{cancel_billing_id:getbilling_id},success:function(response,options){var rsp=Ext.decode(response.responseText);me.clearBilling();if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}
Ext.getCmp("grid_billingCashier_activeBilling").store.load();Ext.getCmp("grid_billingCashier_paidBilling").store.load();myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},lockBillingCashier:function(xvar){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();var getbilling_id=formBilling.findField('billing_id').getValue();var getbilling_no=formBilling.findField('billing_no').getValue();if(getbilling_no==''){return false;}
var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail'),{msg:"Lock/Unlock #"+getbilling_no+"..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Lock/Unlock ...',url:appUrl+'cashier/billingCashier/lockBilling?_dc='+d.getTime(),method:'POST',params:{billing_id:getbilling_id,value:xvar},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{me.CURR_BILL_DATA.lock_billing=xvar;}
if(xvar==0){Ext.getCmp('lockButton_billingCashier').hide();Ext.getCmp('unlockButton_billingCashier').show();}else{Ext.getCmp('lockButton_billingCashier').show();Ext.getCmp('unlockButton_billingCashier').hide();}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},confirmHoldBilling:function(){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();var getbilling_id=formBilling.findField('billing_id').getValue();var getbilling_no=formBilling.findField('billing_no').getValue();var infoIfPaid='';if(me.CURR_BILL_DATA.billing_status=='paid'){infoIfPaid='<br/>This Billing been Paid, Hold Billing will need Supervisor Access';}
if(getbilling_no!=''){ExtApp.Msg.confirm('Hold Billing: #'+getbilling_no+'?'+infoIfPaid,false,function(btn){if(btn=='yes'){if(me.CURR_BILL_DATA.billing_status=='paid'){me.verifySupervisorLogin('Hold Billing');}else{me.doHoldBilling();}}else{return false;}});}else{ExtApp.Msg.warning('Error: Billing Not Found!');return false;}},doHoldBilling:function(){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();var getbilling_id=formBilling.findField('billing_id').getValue();var getbilling_no=formBilling.findField('billing_no').getValue();var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail'),{msg:"Hold Billing #"+getbilling_no+"..."});myMask.show();Ext.getCmp(me.id+'_newBilling_button').setDisabled(true);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(true);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(true);Ext.getCmp(me.id+'_payBilling_button').setDisabled(true);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);var d=new Date();Ext.Ajax.request({waitMsg:'Hold ...',url:appUrl+'cashier/billingCashier/holdBilling?_dc='+d.getTime(),method:'POST',params:{hold_billing_id:getbilling_id},success:function(response,options){var rsp=Ext.decode(response.responseText);me.clearBilling();if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}
Ext.getCmp("grid_billingCashier_activeBilling").store.load();Ext.getCmp("grid_billingCashier_holdBilling").store.load();myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},doHoldBillingPaid:function(){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();var getbilling_id=formBilling.findField('billing_id').getValue();var getbilling_no=formBilling.findField('billing_no').getValue();var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail'),{msg:"Hold Billing #"+getbilling_no+"..."});myMask.show();Ext.getCmp(me.id+'_newBilling_button').setDisabled(true);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(true);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(true);Ext.getCmp(me.id+'_payBilling_button').setDisabled(true);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);var d=new Date();Ext.Ajax.request({waitMsg:'Hold ...',url:appUrl+'cashier/billingCashier/holdBillingPaid?_dc='+d.getTime(),method:'POST',params:{cancel_billing_id:getbilling_id},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}
me.CURR_BILL_DATA.billing_status='hold';Ext.getCmp("grid_billingCashier_holdBilling").store.load();Ext.getCmp("grid_billingCashier_paidBilling").store.load();Ext.getCmp(me.id+'_newBilling_button').setDisabled(false);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(false);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(false);Ext.getCmp(me.id+'_payBilling_button').setDisabled(false);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(false);myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},confirmPayBilling:function(){var me=this;var getBillingData=me.CURR_BILL_DATA;if(!getBillingData.billing_id){ExtApp.Msg.warning('Error: Billing Not Found!');}else{var d=Ext.getCmp('grid_billingCashier_billingDetail').store.getRange(0);if(d.length>0){if(me.CURR_BILL_DATA.billing_status=='paid'){me.onlyPrintBilling();}else{if(!ExtApp.asCashier){ExtApp.asCashier=0;}
if(ExtApp.asCashier==1){me.createWindow(me,'payBilling');}else{me.createWindow(me,'printBilling');}}}else{ExtApp.Msg.warning('There is No Product, Pay Canceled!');}}},onlyPrintBilling:function(){var me=this;ExtApp.Msg.confirm('Billing: '+me.CURR_BILL_DATA.billing_no+' been paid<br/>Print Billing Receipt Again?',false,function(btn){if(btn=='yes'){var getDataBilling=me.CURR_BILL_DATA;me.doPrint('payBilling',getDataBilling,0);}else{return false;}});},save_orderProduct:function(){var me=this;var form=Ext.getCmp('form_orderProduct').getForm();var formBilling=Ext.getCmp('form_billingCashier').getForm();var get_billing_id=formBilling.findField('billing_id').getValue();var product_name=form.findField('product_name').getValue();if(me.save_progress_orderProduct){ExtApp.Msg.warning('Please wait..<br/>Order Product/Menu on Progress');return false;}
me.save_progress_orderProduct=true;var phpJs=me.app.getHelper('phpJs');if(me.CURR_BILL_DATA.billing_status=='paid'){me.save_progress_orderProduct=false;ExtApp.Msg.warning('This Billing been Paid!<br/>Please Change Billing Status to Hold Billing to Add/Edit Billing Item');return false;}
if(get_billing_id==''){}
if(form.isValid()){var data_order_billing_detail_id=form.findField('id').getValue();var data_order_billing_id=form.findField('billing_id').getValue();var data_order_category_id=form.findField('category_id').getValue();var data_order_form_type_orderProduct=form.findField('form_type_orderProduct').getValue();var data_order_main_billing_id=get_billing_id;var data_order_order_notes=form.findField('order_notes').getValue();var data_order_order_qty=form.findField('order_qty').getValue();var data_order_product_id=form.findField('product_id').getValue();var data_order_product_normal_price=form.findField('product_normal_price').getValue();var data_order_product_price=form.findField('product_price').getValue();var data_order_product_price_hpp=form.findField('product_price_hpp').getValue();var data_order_product_varian_id=form.findField('product_varian_id').getValue();var data_order_varian_id=form.findField('varian_id').getValue();var data_order_has_varian=form.findField('has_varian').getValue();var data_order_is_takeaway=form.findField('is_takeaway').getSubmitValue();var data_order_is_compliment=form.findField('is_compliment').getSubmitValue();var data_order_is_promo=form.findField('is_promo').getValue();var data_order_promo_id=form.findField('promo_id').getValue();var data_order_promo_tipe=form.findField('promo_tipe').getValue();var data_order_promo_percentage=form.findField('promo_percentage').getValue();var data_order_promo_price=form.findField('promo_price').getValue();var data_order_promo_desc=form.findField('promo_desc').getValue();var data_order_use_tax=form.findField('use_tax').getValue();var data_order_use_service=form.findField('use_service').getValue();var data_order_is_buyget=form.findField('is_buyget').getValue();var data_order_buyget_id=form.findField('buyget_id').getValue();var data_order_buyget_tipe=form.findField('buyget_tipe').getValue();var data_order_buyget_percentage=form.findField('buyget_percentage').getValue();var data_order_buyget_qty=form.findField('buyget_qty').getValue();var data_order_buyget_desc=form.findField('buyget_desc').getValue();var data_order_buyget_item=form.findField('buyget_item').getValue();var data_order_free_item=form.findField('free_item').getValue();if(data_order_has_varian==1&&data_order_varian_id==0){me.save_progress_orderProduct=false;ExtApp.Msg.warning('Please select size/portion!');return false;}
me.doClose(me.id+'_orderProduct');var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail'),{msg:"Saving Order..."});myMask.show();Ext.getCmp(me.id+'_newBilling_button').setDisabled(true);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(true);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(true);Ext.getCmp(me.id+'_payBilling_button').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);var d=new Date();Ext.Ajax.request({waitMsg:'Hold ...',url:appUrl+'cashier/billingCashier/save_orderProduct?_dc='+d.getTime(),method:'POST',params:{id:data_order_billing_detail_id,billing_id:data_order_billing_id,category_id:data_order_category_id,form_type_orderProduct:data_order_form_type_orderProduct,main_billing_id:data_order_main_billing_id,order_notes:data_order_order_notes,order_qty:data_order_order_qty,product_id:data_order_product_id,product_normal_price:data_order_product_normal_price,product_price:data_order_product_price,product_price_hpp:data_order_product_price_hpp,product_varian_id:data_order_product_varian_id,varian_id:data_order_varian_id,has_varian:data_order_has_varian,is_takeaway:data_order_is_takeaway,is_compliment:data_order_is_compliment,is_promo:data_order_is_promo,promo_id:data_order_promo_id,promo_tipe:data_order_promo_tipe,promo_percentage:data_order_promo_percentage,promo_price:data_order_promo_price,promo_desc:data_order_promo_desc,use_tax:data_order_use_tax,use_service:data_order_use_service,is_buyget:data_order_is_buyget,buyget_id:data_order_buyget_id,buyget_tipe:data_order_buyget_tipe,buyget_percentage:data_order_buyget_percentage,buyget_qty:data_order_buyget_qty,buyget_desc:data_order_buyget_desc,buyget_item:data_order_buyget_item,free_item:data_order_free_item,},success:function(response,options){me.save_progress_orderProduct=false;me.doClose(me.id+'_orderProduct');myMask.hide();Ext.getCmp(me.id+'_newBilling_button').setDisabled(false);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(false);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(false);Ext.getCmp(me.id+'_payBilling_button').setDisabled(false);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(false);var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.error('Save Failed, '+rsp.info);return false;}
if(get_billing_id==''){Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp("grid_billingCashier_activeBilling").store.load();if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;me.openBillingData();}else{me.store_billingCashierDetail.proxy.extraParams.billing_id=rsp.billingData.billing_id;me.load_store_billingCashierDetail();}}else{if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;if(rsp.billingData.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}
if(rsp.billingData.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}
if(rsp.billingData.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}}
me.load_store_billingCashierDetail();}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Save Failed, '+rsp.info);myMask.hide();me.save_progress_orderProduct=false;Ext.getCmp(me.id+'_newBilling_button').setDisabled(false);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(false);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(false);Ext.getCmp(me.id+'_payBilling_button').setDisabled(false);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(false);}});}else{me.save_progress_orderProduct=false;}},load_store_billingCashierDetail:function(after_open){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();var phpJs=me.app.getHelper('phpJs');Ext.getCmp(me.id+'_newBilling_button').setDisabled(true);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(true);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(true);Ext.getCmp(me.id+'_payBilling_button').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);me.store_billingCashierDetail.load({callback:function(records,operation,success){me.suspend_button_on_billing_load=false;Ext.getCmp(me.id+'_newBilling_button').setDisabled(false);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(false);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(false);Ext.getCmp(me.id+'_payBilling_button').setDisabled(false);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('returOrderButton_billingCashier_billingDetail').setDisabled(false);Ext.getCmp('grid_billingCashier_billingDetail').getSelectionModel().deselectAll();if(after_open=='mergeBill'||after_open=='unMergeBill'||after_open=='splitBill'){}else{me.loadBilling('billing_detail');}
if(after_open=='cancel'){me.confirmCancelBilling();}
if(after_open=='hold'){me.confirmHoldBilling();}}});},loadBilling:function(xfrom){var me=this;if(!me.CURR_BILL_DATA.billing_id){ExtApp.Msg.warning('load billing failed!');}
if(me.CURR_BILL_DATA.billing_id==0){me.CURR_BILL_DATA.billing_id=-1;}
var d=new Date();Ext.Ajax.request({waitMsg:'Re-Load Billing ...',url:appUrl+'cashier/billingCashier/loadBilling?_dc='+d.getTime(),method:'POST',params:{billing_id:me.CURR_BILL_DATA.billing_id},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}
if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;}
if(xfrom=='billing_detail'){var formBilling=Ext.getCmp('form_billingCashier').getForm();var phpJs=me.app.getHelper('phpJs');formBilling.findField('total_billingDetail').setValue('Rp '+phpJs.priceFormat(me.CURR_BILL_DATA.total_billing_display));if(me.CURR_BILL_DATA.billing_status=='paid'){Ext.getCmp('returOrderButton_billingCashier_billingDetail').setDisabled(false);}else{Ext.getCmp('returOrderButton_billingCashier_billingDetail').setDisabled(true);}}},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);}});},returConfirmOrderBillingDetail:function(){var me=this;me.createWindow(me,'returOrder');},deleteConfirmOrderBillingDetail:function(){var me=this;if(me.deleteOrderData.id){var getDeliver=false;var deliverName=[];var getSelection=Ext.getCmp('grid_billingCashier_billingDetail').getSelectionModel().selected;var delete_var={allID:[],allName:''};for(x in getSelection.items){delete_var.allID.push(getSelection.items[x].data.id);if(delete_var.allName==''){delete_var.allName=getSelection.items[x].data.product_name;}else{delete_var.allName+=', '+getSelection.items[x].data.product_name;}
if(getSelection.items[x].data.order_status=='done'){getDeliver=true;if(deliverName==''){deliverName=getSelection.items[x].data.product_name;}else{deliverName+=', '+getSelection.items[x].data.product_name;}}}
if(getDeliver==true){me.cancelOrder_spv_valid=1;me.verifySupervisorLogin('Cancel Order',delete_var.allName);}else{me.deleteOrderBillingDetail();}}else{ExtApp.Msg.info("Please Choose data");}},deleteOrderBillingDetail:function(){var me=this;var getDeliver=false;var deliverName=[];var getSelection=Ext.getCmp('grid_billingCashier_billingDetail').getSelectionModel().selected;var delete_var={allID:[],allName:''};for(x in getSelection.items){delete_var.allID.push(getSelection.items[x].data.id);if(delete_var.allName==''){delete_var.allName=getSelection.items[x].data.product_name;}else{delete_var.allName+=', '+getSelection.items[x].data.product_name;}
if(getSelection.items[x].data.order_status=='done'){getDeliver=true;if(deliverName==''){deliverName=getSelection.items[x].data.product_name;}else{deliverName+=', '+getSelection.items[x].data.product_name;}}}
if(!delete_var.allID){ExtApp.Msg.info("Order Item Undefined!");return;}
var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail'),{msg:"Cancelling Order: "+delete_var.allName+"..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Cancel ...',url:appUrl+'cashier/billingCashier/cancelOrder?_dc='+d.getTime(),method:'POST',params:{spv_valid:me.cancelOrder_spv_valid,keterangan:me.cancelOrder_keterangan,qty:me.cancelOrder_qty,id:Ext.JSON.encode(delete_var.allID)},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}
me.cancelOrder_spv_valid=0;me.cancelOrder_keterangan='';me.load_store_billingCashierDetail();myMask.hide();if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;if(rsp.billingData.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}
if(rsp.billingData.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}
if(rsp.billingData.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}}},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);me.cancelOrder_spv_valid=0;me.cancelOrder_keterangan='';myMask.hide();}});},openBillingData:function(after_open){var me=this;if(!me.suspend_button_on_billing_load){me.suspend_button_on_billing_load=false;}
if(me.suspend_button_on_billing_load==false){me.suspend_button_on_billing_load=true;}else{ExtApp.Msg.info("Please Wait, Billing: "+me.CURR_BILL_DATA.billing_no+" on Load!");return;}
if(me.data_billing.billing_id&&me.suspend_button_on_billing_load==true){var getDataBilling=me.data_billing;if(getDataBilling.merge_billing_no!=''){if(getDataBilling.merge_billing_no!=getDataBilling.billing_no){me.suspend_button_on_billing_load=false;ExtApp.Msg.info("This Billing currently Merge with Billing:#"+getDataBilling.merge_billing_no+"<br/>please select Billing:#"+getDataBilling.merge_billing_no+" to pay billing!");return;}}
var formBilling=Ext.getCmp('form_billingCashier').getForm();formBilling.findField('billingCashier_billing_no').setValue('#'+getDataBilling.billing_no);formBilling.findField('billingCashier_billing_datetime').setValue(getDataBilling.created_datetime);formBilling.findField('billing_id').setValue(getDataBilling.billing_id);formBilling.findField('billing_no').setValue(getDataBilling.billing_no);formBilling.findField('billing_status').setValue(getDataBilling.billing_status);me.store_billingCashierDetail.proxy.extraParams.billing_id=getDataBilling.billing_id;me.CURR_BILL_DATA=getDataBilling;getDataBilling.data=getDataBilling;formBilling.setValues(getDataBilling);me.load_store_billingCashierDetail(after_open);Ext.getCmp('billingCashier_table_id').setValue(getDataBilling.table_id);Ext.getCmp('billingCashier_table_no').setValue(getDataBilling.table_no);Ext.getCmp('billingCashier_total_guest').setValue(getDataBilling.total_guest);if(me.CURR_BILL_DATA.lock_billing==0){Ext.getCmp('lockButton_billingCashier').hide();Ext.getCmp('unlockButton_billingCashier').show();}else{Ext.getCmp('lockButton_billingCashier').show();Ext.getCmp('unlockButton_billingCashier').hide();}}else{ExtApp.Msg.info("Billing not Undefined!");return;}},clearBilling:function(){var me=this;var formBilling=Ext.getCmp('form_billingCashier').getForm();formBilling.reset();me.CURR_BILL_DATA={};var EmptyData=[];me.store_billingCashierDetail.proxy.extraParams.billing_id=-1;me.store_billingCashierDetail.loadData(EmptyData);Ext.getCmp(me.id+'_newBilling_button').setDisabled(false);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(false);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(false);Ext.getCmp(me.id+'_payBilling_button').setDisabled(false);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('returOrderButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('billingCashier_table_id').setValue('');Ext.getCmp('billingCashier_table_no').setValue('');Ext.getCmp('billingCashier_total_guest').setValue('');},printReceipt_printBilling:function(xvar,printer_id,getDataBilling_post){var me=this;var phpJs=me.app.getHelper('phpJs');var getDataBilling=me.CURR_BILL_DATA;if(!getDataBilling_post){}else{getDataBilling=getDataBilling_post;}
if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
if(!getDataBilling.table_id){getDataBilling.table_id=0;}
if(getDataBilling.table_id==''||getDataBilling.table_id==0){ExtApp.Msg.warning("Table Unidentified!");return;}
if(getDataBilling.total_guest==0){ExtApp.Msg.warning("Total Guest Cannot Empty!");return;}
if(!printer_id){var printer_id=0;}
if(xvar==6){setTimeout(function(){me.doPrint('payBilling',getDataBilling,3,printer_id);},1000);setTimeout(function(){me.doPrint('payBilling',getDataBilling,4,printer_id);},3000);setTimeout(function(){me.doPrint('payBilling',getDataBilling,5,printer_id);},5000);}else{if(opt_print_qc_then_order=='1'&&xvar==7){me.doPrint('payBilling',getDataBilling,2,printer_id);setTimeout(function(){me.doPrint('payBilling',getDataBilling,3,printer_id);},1000);setTimeout(function(){me.doPrint('payBilling',getDataBilling,4,printer_id);},3000);setTimeout(function(){me.doPrint('payBilling',getDataBilling,5,printer_id);},5000);}else{me.doPrint('payBilling',getDataBilling,xvar,printer_id);}}},printReceipt_payBilling:function(xvar,printer_id){var me=this;var form=Ext.getCmp('form_payBilling').getForm();var phpJs=me.app.getHelper('phpJs');var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
var table_id=form.findField('table_id').getValue();if(getDataBilling.table_id==''||table_id==''){ExtApp.Msg.warning("Table Unidentified!");return;}
var total_guest=form.findField('total_guest').getValue();if(getDataBilling.total_guest==0||total_guest==0){ExtApp.Msg.warning("Total Guest Cannot Empty!");return;}
if(!printer_id){var printer_id=0;}
if(xvar==6){setTimeout(function(){me.doPrint('payBilling',getDataBilling,3,printer_id);},2000);setTimeout(function(){me.doPrint('payBilling',getDataBilling,4,printer_id);},4000);setTimeout(function(){me.doPrint('payBilling',getDataBilling,5,printer_id);},6000);}else
if(xvar==7){me.doPrint('pay_and_order',getDataBilling,2,printer_id);setTimeout(function(){me.doPrint('pay_and_order',getDataBilling,3,printer_id);},2000);setTimeout(function(){me.doPrint('pay_and_order',getDataBilling,4,printer_id);},4000);setTimeout(function(){me.doPrint('pay_and_order',getDataBilling,5,printer_id);},6000);Ext.getCmp('grid_billingCashier_activeBilling').store.load();Ext.getCmp('grid_billingCashier_holdBilling').store.load();Ext.getCmp('grid_billingCashier_paidBilling').store.load();me.doClose(me.id+'_payBilling');me.clearBilling();}else
{me.doPrint('payBilling',getDataBilling,xvar,printer_id);}},save_infoBilling:function(){var me=this;var form=Ext.getCmp('form_payBilling').getForm();var phpJs=me.app.getHelper('phpJs');var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
var get_payment_id=Ext.getCmp('payment_id_group_payBilling').getChecked();var payment_id=get_payment_id[0].inputValue;var bank_id=form.findField('bank_id').getValue();var card_no=form.findField('card_no').getValue();var billing_notes=form.findField('billing_notes').getValue();var qc_notes=form.findField('qc_notes').getValue();var single_rate=form.findField('single_rate').getSubmitValue();var customer_id=form.findField('customer_id').getValue();var customer_name=form.findField('customer_name').getValue();var sales_id=form.findField('sales_id').getValue();var sales_name=form.findField('sales_name').getValue();var sales_percentage=form.findField('sales_percentage').getValue();var sales_price=form.findField('sales_price').getValue();var sales_type=form.findField('sales_type').getValue();var myMask=new Ext.LoadMask(Ext.getCmp('form_payBilling'),{msg:"Save Info..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Cancel ...',url:appUrl+'cashier/billingCashier/save_infoBilling?_dc='+d.getTime(),method:'POST',params:{billing_id:getDataBilling.billing_id,payment_id:payment_id,bank_id:bank_id,card_no:card_no,billing_notes:billing_notes,qc_notes:qc_notes,single_rate:single_rate,customer_id:customer_id,customer_name:customer_name,sales_id:sales_id,sales_name:sales_name,sales_percentage:sales_percentage,sales_price:sales_price,sales_type:sales_type},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{if(rsp.retData){me.CURR_BILL_DATA.payment_id=rsp.retData.payment_id;me.CURR_BILL_DATA.bank_id=rsp.retData.bank_id;me.CURR_BILL_DATA.card_no=rsp.retData.card_no;me.CURR_BILL_DATA.billing_notes=rsp.retData.billing_notes;me.CURR_BILL_DATA.qc_notes=rsp.retData.qc_notes;me.CURR_BILL_DATA.single_rate=rsp.retData.single_rate;me.CURR_BILL_DATA.customer_id=rsp.retData.customer_id;me.CURR_BILL_DATA.customer_name=rsp.retData.customer_name;me.CURR_BILL_DATA.sales_id=rsp.retData.sales_id;me.CURR_BILL_DATA.sales_name=rsp.retData.sales_name;me.CURR_BILL_DATA.sales_percentage=rsp.retData.sales_percentage;me.CURR_BILL_DATA.sales_price=rsp.retData.sales_price;me.CURR_BILL_DATA.sales_type=rsp.retData.sales_type;}}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},save_payBilling:function(){var me=this;var form=Ext.getCmp('form_payBilling').getForm();var phpJs=me.app.getHelper('phpJs');var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
var table_id=form.findField('table_id').getValue();if(getDataBilling.table_id==''||table_id==''){ExtApp.Msg.warning("Table Unidentified!");return;}
var total_guest=form.findField('total_guest').getValue();if(getDataBilling.total_guest==0||total_guest==0){ExtApp.Msg.warning("Total Guest Cannot Empty!");return;}
var payment_id=form.findField('payment_id').getValue();var bank_id=form.findField('bank_id').getValue();var card_no=form.findField('card_no').getValue();if(payment_id!=1){if(bank_id==''||card_no==''){ExtApp.Msg.warning("Select BANK and Input TRX NO!");return false;}}
var total_paid=phpJs.numberFormat(form.findField('total_paid').getValue());if(!total_paid){total_paid=0;}
if(total_paid==0&&getDataBilling.discount_percentage<100){}
var grand_total=parseFloat(form.findField('grand_total').getValue());if(total_paid==0){if(total_paid==grand_total){}else{if(total_paid==0&&getDataBilling.discount_percentage<100){ExtApp.Msg.warning('Total Paid Cannot Empty!');return false;}}}
if(total_paid<grand_total){ExtApp.Msg.warning('Total Paid cannot lower than Total Billing!');return false;}
ExtApp.Msg.confirm('Are You Sure Pay Billing: '+me.CURR_BILL_DATA.billing_no+'?<br/>Total: '+grand_total,false,function(btn){if(btn=='yes'){Ext.getCmp(me.id+'_newBilling_button').setDisabled(true);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(true);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(true);Ext.getCmp(me.id+'_payBilling_button').setDisabled(true);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);var d=new Date();if(form.isValid()){form.submit({clientValidation:true,scope:me,url:appUrl+'cashier/billingCashier/save_payBilling?_dc='+d.getTime(),method:'POST',params:{},waitMsg:'Pay Bill: '+getDataBilling.billing_no+'...',success:function(mainObj,formObj){if(opt_print_qc_order_when_payment==1){if(opt_show_multiple_print_billing=='1'){me.doPrint('payBilling',getDataBilling,0);setTimeout(function(){me.doPrint('payBilling',getDataBilling,0);},3000);setTimeout(function(){me.printReceipt_payBilling(7);},4000);}else{me.doPrint('payBilling',getDataBilling,0);setTimeout(function(){me.printReceipt_payBilling(7);},3000);}}else{if(opt_show_multiple_print_billing=='1'){me.doPrint('payBilling',getDataBilling,0);setTimeout(function(){me.doPrint('payBilling',getDataBilling,0);},3000);}else{me.doPrint('payBilling',getDataBilling,0);}
Ext.getCmp('grid_billingCashier_activeBilling').store.load();Ext.getCmp('grid_billingCashier_holdBilling').store.load();Ext.getCmp('grid_billingCashier_paidBilling').store.load();me.doClose(me.id+'_payBilling');me.clearBilling();}},failure:function(mainObj,formObj){var rsp=Ext.decode(formObj.response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Pay Bill Failed, '+rsp.info);}});}}else{return false;}});},save_halfPayment_billingCashier:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var form_halfPayment=Ext.getCmp('form_halfPayment_billingCashier').getForm();var form_payBilling=Ext.getCmp('form_payBilling').getForm();var getDataBilling=me.CURR_BILL_DATA;if(form_halfPayment.isValid()){var total_billing=parseFloat(form_payBilling.findField('grand_total').getValue());var total_cash=parseFloat(form_halfPayment.findField('total_cash').getValue());var total_credit=parseFloat(form_halfPayment.findField('total_credit').getValue());var cek_selisih=parseFloat(total_billing)-(total_cash+total_credit);if(cek_selisih==0&&total_cash<total_billing&&total_cash!=0){if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
var table_id=form_payBilling.findField('table_id').getValue();if(getDataBilling.table_id==''||table_id==''){ExtApp.Msg.warning("Table Unidentified!");return;}
var total_guest=form_payBilling.findField('total_guest').getValue();if(getDataBilling.total_guest==0||total_guest==0){ExtApp.Msg.warning("Total Guest Cannot Empty!");return;}
var payment_id=form_payBilling.findField('payment_id').getValue();var bank_id=form_payBilling.findField('bank_id').getValue();var card_no=form_payBilling.findField('card_no').getValue();if(payment_id!=1){if(bank_id==''||card_no==''){ExtApp.Msg.warning("Select BANK and Input TRX NO!");return false;}}
var total_cash_show=phpJs.priceFormat(total_cash);var total_credit_show=phpJs.priceFormat(total_credit);var total_billing_show=phpJs.priceFormat(total_billing);ExtApp.Msg.confirm('Are You Sure Pay Billing: '+me.CURR_BILL_DATA.billing_no+'?<br/>Cash: '+total_cash_show+'<br/>Credit: '+total_credit_show+'<br/>Total: '+total_billing_show,false,function(btn){if(btn=='yes'){form_payBilling.findField('total_cash').setValue(total_cash);form_payBilling.findField('total_credit').setValue(total_credit);form_payBilling.findField('total_paid').setValue(total_billing);Ext.getCmp(me.id+'_newBilling_button').setDisabled(true);Ext.getCmp(me.id+'_cancelBilling_button').setDisabled(true);Ext.getCmp(me.id+'_holdBilling_button').setDisabled(true);Ext.getCmp(me.id+'_payBilling_button').setDisabled(true);Ext.getCmp('setTableButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('setGuestButton_billingCashier_billingDetail').setDisabled(true);Ext.getCmp('deleteButton_billingCashier_billingDetail').setDisabled(true);var d=new Date();if(form_payBilling.isValid()){form_payBilling.submit({clientValidation:true,scope:me,url:appUrl+'cashier/billingCashier/save_payBilling?_dc='+d.getTime(),method:'POST',params:{},waitMsg:'Half Pay Bill: '+getDataBilling.billing_no+'...',success:function(mainObj,formObj){me.doClose(me.id+'_halfPayment');me.doClose(me.id+'_payBilling');if(opt_show_multiple_print_billing=='1'){me.doPrint('payBilling',getDataBilling,0);setTimeout(function(){me.doPrint('payBilling',getDataBilling,0);},7000);}else{me.doPrint('payBilling',getDataBilling,0);}
Ext.getCmp('grid_billingCashier_activeBilling').store.load();Ext.getCmp('grid_billingCashier_holdBilling').store.load();Ext.getCmp('grid_billingCashier_paidBilling').store.load();me.clearBilling();},failure:function(mainObj,formObj){var rsp=Ext.decode(formObj.response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Half Pay Bill Failed, '+rsp.info);return false;}});}}else{return false;}});}else{ExtApp.Msg.error('Total Billing = '+phpJs.number_format(total_billing)+'<br/>Check Total Cash and Credit');return false;}}else{return false;}},doPrint:function(tipe,getDataBilling,print_type,printer_id){var me=this;var getTipePayment=tipe;if(tipe=='pay_and_order'){tipe='payBilling';}
var d=new Date();Ext.Ajax.request({waitMsg:'Printing...',url:appUrl+'cashier/billingCashier/doPrint?_dc='+d.getTime(),method:'POST',params:{tipe:tipe,printer_id:printer_id,print_type:print_type,id:getDataBilling.billing_id},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){if(!rsp.info){rsp.info='Print Failed!';}
if(rsp.info=='Belum ada order Kitchen'||rsp.info=='Belum ada order Bar'||rsp.info=='Belum ada order Other'){}else{ExtApp.Msg.warning(rsp.info);}}else{if(getTipePayment=='payBilling'&&(print_type==3||print_type==4||print_type==5)){me.load_store_billingCashierDetail();}}},failure:function(response,options){if(!response.responseText){if(!response.responseText){ExtApp.Msg.warning('Print Failed!');}else{var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);}}else{ExtApp.Msg.warning('Print Failed!');}}});},calcBillingTotal:function(xupdate){var me=this;var theApp=me.app;var phpJs=theApp.getHelper('phpJs');var form=Ext.getCmp('form_payBilling').getForm();var getDataBilling=me.CURR_BILL_DATA;var total_billing=parseFloat(getDataBilling.total_billing);var grand_total=parseFloat(getDataBilling.grand_total);var tax_total=parseFloat(getDataBilling.tax_total);var service_total=parseFloat(getDataBilling.service_total);var total_discount=parseFloat(getDataBilling.total_discount);var compliment_total=parseFloat(getDataBilling.compliment_total);total_ppn=parseFloat(phpJs.str_replace('.00','',tax_total));total_service=parseFloat(phpJs.str_replace('.00','',service_total));var total_discount=getDataBilling.discount_total;total_discount=parseFloat(total_discount);var total_dp=getDataBilling.total_dp;total_downpayment=0;if(total_dp>0){total_downpayment=phpJs.number_format(total_dp,0,'.','');}
var total_pembulatan=getDataBilling.total_pembulatan;form.findField('total_billing').setValue(total_billing);form.findField('total_discount').setValue(total_discount);form.findField('total_ppn').setValue(total_ppn);form.findField('total_service').setValue(total_service);form.findField('total_dp').setValue(total_dp);form.findField('grand_total').setValue(grand_total);form.findField('total_pembulatan').setValue(total_pembulatan);form.findField('compliment_total').setValue(compliment_total);var total_billing_rp='Rp '+phpJs.priceFormat(total_billing);var total_discount_rp='Rp '+phpJs.priceFormat(total_discount);var total_ppn_rp='Rp '+phpJs.priceFormat(total_ppn);var total_service_rp='Rp '+phpJs.priceFormat(total_service);var total_dp_rp='Rp '+phpJs.priceFormat(total_downpayment);var grand_total_rp='Rp '+phpJs.priceFormat(grand_total);var total_pembulatan_rp='Rp '+phpJs.priceFormat(total_pembulatan);var total_compliment_rp='Rp '+phpJs.priceFormat(compliment_total);form.findField('total_billing_rp').setValue(total_billing_rp);form.findField('total_discount_rp').setValue(total_discount_rp);form.findField('total_ppn_rp').setValue(total_ppn_rp);form.findField('total_service_rp').setValue(total_service_rp);form.findField('total_dp_rp').setValue(total_dp_rp);form.findField('grand_total_rp').setValue(grand_total_rp);form.findField('total_pembulatan_rp').setValue(total_pembulatan_rp);form.findField('total_compliment_rp').setValue(total_compliment_rp);form.findField('total_paid').setValue(grand_total);form.findField('total_return').setValue(0);form.findField('total_return_rp').setValue('Rp 0');},verifySupervisorLogin:function(afterVerify,msgVar){var me=this;var supervisor=me.app.getHelper('supervisor');var getDataBilling=me.CURR_BILL_DATA;if(!msgVar){msgVar='';}
var infoVerify='Cancel Billing (Void) no: #'+getDataBilling.billing_no;var trigger_button=me.id+'_cancelBilling_save';var title_verify='Cancel Billing (Void)';var access_verify='cancel_billing';if(afterVerify=='Cancel Billing From Paid Billing'){var infoVerify='Cancel Billing (Void) no: #'+getDataBilling.billing_no;var trigger_button=me.id+'_cancelBillingPaid_save';var title_verify='Cancel Billing (Void)';var access_verify='cancel_billing';}else
if(afterVerify=='Hold Billing'){title_verify='Cancel Billing (Void)';infoVerify='Cancel Billing (Void) and Set to Hold Billing no: #'+getDataBilling.billing_no;trigger_button=me.id+'_holdBilling_save';access_verify='cancel_billing';}else
if(afterVerify=='Cancel Order'){title_verify='Cancel Order (Void)';infoVerify='Cancel Order '+msgVar+' on Billing no: #'+getDataBilling.billing_no;trigger_button=me.id+'_cancelOrder_save';access_verify='cancel_order';}
var verifySpvData={title:title_verify,verifyMode:0,access:access_verify,log:1,data:infoVerify,saveBtn:trigger_button};var get_access_spv=-1;if(!opt_spv_access_active){get_access_spv=-1;}else{get_access_spv=opt_spv_access_active.indexOf(access_verify);}
if(get_access_spv==-1){if(access_verify=='Cancel Billing From Paid Billing'){me.doCancelBillingPaid();}else
if(afterVerify=='Hold Billing'){me.doHoldBillingPaid();}else
if(afterVerify=='Cancel Order'){me.deleteOrderBillingDetail();}else{me.doCancelBilling();}}else{supervisor.login(verifySpvData,me);}},testPrinter:function(printSetting){if(!printSetting){printSetting='cashierReceipt';}
var myMask=new Ext.LoadMask(Ext.getCmp('form_settingCashier_'+printSetting),{msg:"Loading..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Printing...',url:appUrl+'cashier/billingCashier/testPrinter?_dc='+d.getTime(),method:'POST',params:{printSetting:printSetting},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},cutPrinter:function(printSetting){if(!printSetting){printSetting='cashierReceipt';}
var myMask=new Ext.LoadMask(Ext.getCmp('form_settingCashier_'+printSetting),{msg:"Loading..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Printing...',url:appUrl+'cashier/billingCashier/testPrinter?_dc='+d.getTime(),method:'POST',params:{cutting_only:true,printSetting:printSetting},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},loadSettingCashier:function(){var me=this;var myMask=new Ext.LoadMask(Ext.getCmp('tab_billingCashier_printerReceipt'),{msg:"Loading..."});myMask.show();var formCashierReceipt=Ext.getCmp('form_settingCashier_cashierReceipt').getForm();var formQCReceipt=Ext.getCmp('form_settingCashier_qcReceipt').getForm();var formKitchenReceipt=Ext.getCmp('form_settingCashier_kitchenReceipt').getForm();var formBarReceipt=Ext.getCmp('form_settingCashier_barReceipt').getForm();var formOtherReceipt=Ext.getCmp('form_settingCashier_otherReceipt').getForm();var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/loadingSetting?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);me.doClose(me.id+'_settingCashier');}else{if(rsp.cashierReceipt.use_local_default_printer==true){formCashierReceipt.findField('use_local_default_printer').setValue(rsp.cashierReceipt.use_local_default_printer);formCashierReceipt.findField('printer_ip').setValue('');formCashierReceipt.findField('printer_tipe').setValue('');formCashierReceipt.findField('printer_pin').setValue('');}else{formCashierReceipt.findField('use_local_default_printer').setValue(false);formCashierReceipt.findField('printer_ip').setValue(rsp.cashierReceipt.printer_ip);formCashierReceipt.findField('printer_tipe').setValue(rsp.cashierReceipt.printer_tipe);formCashierReceipt.findField('printer_pin').setValue(rsp.cashierReceipt.printer_pin);}
if(rsp.qcReceipt.print_qcReceipt==true){formQCReceipt.findField('print_qcReceipt').setValue(true);}else{formQCReceipt.findField('print_qcReceipt').setValue(false);}
if(rsp.qcReceipt.use_local_default_printer==true){formQCReceipt.findField('use_local_default_printer').setValue(true);formQCReceipt.findField('printer_ip').setValue('');formQCReceipt.findField('printer_tipe').setValue('');formQCReceipt.findField('printer_pin').setValue('');}else{formQCReceipt.findField('use_local_default_printer').setValue(false);formQCReceipt.findField('printer_ip').setValue(rsp.qcReceipt.printer_ip);formQCReceipt.findField('printer_tipe').setValue(rsp.qcReceipt.printer_tipe);formQCReceipt.findField('printer_pin').setValue(rsp.qcReceipt.printer_pin);}
if(rsp.kitchenReceipt.print_kitchenReceipt==true){formKitchenReceipt.findField('print_kitchenReceipt').setValue(true);}else{formKitchenReceipt.findField('print_kitchenReceipt').setValue(false);}
if(rsp.kitchenReceipt.use_local_default_printer==true){formKitchenReceipt.findField('use_local_default_printer').setValue(true);formKitchenReceipt.findField('printer_ip').setValue('');formKitchenReceipt.findField('printer_tipe').setValue('');formKitchenReceipt.findField('printer_pin').setValue('');}else{formKitchenReceipt.findField('use_local_default_printer').setValue(false);formKitchenReceipt.findField('printer_ip').setValue(rsp.kitchenReceipt.printer_ip);formKitchenReceipt.findField('printer_tipe').setValue(rsp.kitchenReceipt.printer_tipe);formKitchenReceipt.findField('printer_pin').setValue(rsp.kitchenReceipt.printer_pin);}
if(rsp.barReceipt.print_barReceipt==true){formBarReceipt.findField('print_barReceipt').setValue(true);}else{formBarReceipt.findField('print_barReceipt').setValue(false);}
if(rsp.barReceipt.use_local_default_printer==true){formBarReceipt.findField('use_local_default_printer').setValue(true);formBarReceipt.findField('printer_ip').setValue('');formBarReceipt.findField('printer_tipe').setValue('');formBarReceipt.findField('printer_pin').setValue('');}else{formBarReceipt.findField('use_local_default_printer').setValue(false);formBarReceipt.findField('printer_ip').setValue(rsp.barReceipt.printer_ip);formBarReceipt.findField('printer_tipe').setValue(rsp.barReceipt.printer_tipe);formBarReceipt.findField('printer_pin').setValue(rsp.barReceipt.printer_pin);}
if(rsp.otherReceipt.print_otherReceipt==true){formOtherReceipt.findField('print_otherReceipt').setValue(true);}else{formOtherReceipt.findField('print_otherReceipt').setValue(false);}
if(rsp.otherReceipt.use_local_default_printer==true){formOtherReceipt.findField('use_local_default_printer').setValue(true);formOtherReceipt.findField('printer_ip').setValue('');formOtherReceipt.findField('printer_tipe').setValue('');formOtherReceipt.findField('printer_pin').setValue('');}else{formOtherReceipt.findField('use_local_default_printer').setValue(false);formOtherReceipt.findField('printer_ip').setValue(rsp.otherReceipt.printer_ip);formOtherReceipt.findField('printer_tipe').setValue(rsp.otherReceipt.printer_tipe);formOtherReceipt.findField('printer_pin').setValue(rsp.otherReceipt.printer_pin);}}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);me.doClose(me.id+'_settingCashier');myMask.hide();}});},saveSettingCashier:function(printSetting){if(!printSetting){printSetting='cashierReceipt';}
var me=this;var form=Ext.getCmp('form_settingCashier_'+printSetting).getForm();var d=new Date();if(form.isValid()){form.submit({clientValidation:true,scope:me,url:appUrl+'cashier/billingCashier/save_settingCashier?_dc='+d.getTime(),method:'POST',params:{printSetting:printSetting},waitMsg:'Saving...',success:function(mainObj,formObj){var rsp=Ext.decode(formObj.response.responseText);if(rsp.success==false){ExtApp.Msg.error('Save Setting Failed, '+rsp.info);}else{ExtApp.Msg.info('Setting been Saved!');}},failure:function(mainObj,formObj){var rsp=Ext.decode(formObj.response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Save Setting Failed, '+rsp.info);}});}},updateTableBilling:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
getDataBilling.table_id=Ext.getCmp('billingCashier_table_id').getValue();getDataBilling.table_no=Ext.getCmp('billingCashier_table_no').getValue();me.CURR_BILL_DATA.table_id=getDataBilling.table_id;me.CURR_BILL_DATA.table_no=getDataBilling.table_no;if(getDataBilling.table_id==''){ExtApp.Msg.warning("Table Unidentified!");return;}
if(getDataBilling.billing_id!=''&&getDataBilling.table_id!=''){var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/updateTable?_dc='+d.getTime(),method:'POST',params:{billing_id:getDataBilling.billing_id,table_id:getDataBilling.table_id},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{if(getDataBilling.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}else
if(getDataBilling.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}else
if(getDataBilling.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}}},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);}});}},save_changeTotalGuest_billingCashier:function(from_source){var me=this;var phpJs=me.app.getHelper('phpJs');var form=Ext.getCmp('form_changeTotalGuest_billingCashier').getForm();var total_guest=form.findField('change_total_guest').getValue();if(total_guest==0){ExtApp.Msg.warning("Total Guest Cannot Empty!");return;}
if(form.isValid()){var myMask=new Ext.LoadMask(Ext.getCmp('form_changeTotalGuest_billingCashier'),{msg:"Loading..."});myMask.show();var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
me.CURR_BILL_DATA.total_guest=total_guest;Ext.getCmp('billingCashier_total_guest').setValue(me.CURR_BILL_DATA.total_guest);if(from_source=='form_payBilling'){var form2=Ext.getCmp('form_payBilling').getForm();form2.findField('total_guest_display').setValue(' : '+me.CURR_BILL_DATA.total_guest);form2.findField('total_guest').setValue(me.CURR_BILL_DATA.total_guest);}
if(getDataBilling.billing_id!=''){var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/updateTotalGuest?_dc='+d.getTime(),method:'POST',params:{billing_id:getDataBilling.billing_id,total_guest:me.CURR_BILL_DATA.total_guest},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{me.doClose(me.id+'_changeTotalGuest');if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;if(rsp.billingData.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}
if(rsp.billingData.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}
if(rsp.billingData.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}}}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});}}},verify_changePPN_billingCashier:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var supervisor=me.app.getHelper('supervisor');var form=Ext.getCmp('form_payBilling').getForm();var tax_percentage_old=form.findField('tax_percentage').getValue();var form2=Ext.getCmp('form_changePPN_billingCashier').getForm();var tax_percentage_new=form2.findField('change_ppn_percentage').getValue();var verifySpvData={title:'Change PPN',verifyMode:0,access:'change_ppn',log:1,data:'Change PPN (%) from '+tax_percentage_old+' to '+tax_percentage_new,spvId:me.id+'_changePPN_spv',saveBtn:me.id+'_changePPN_save'};var get_access_spv=-1;if(!opt_spv_access_active){get_access_spv=-1;}else{get_access_spv=opt_spv_access_active.indexOf("change_ppn");}
if(get_access_spv==-1){me.save_changePPN_billingCashier();}else{supervisor.login(verifySpvData,me);}},save_changePPN_billingCashier:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var form=Ext.getCmp('form_changePPN_billingCashier').getForm();if(form.isValid()){var myMask=new Ext.LoadMask(Ext.getCmp('form_changePPN_billingCashier'),{msg:"Loading..."});myMask.show();var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
var total_billing=parseFloat(getDataBilling.total_billing);var tax_percentage=form.findField('change_ppn_percentage').getValue();tax_percentage=parseFloat(tax_percentage);var tax_total=0;if(tax_percentage>0){tax_total=parseFloat((tax_percentage/100)*total_billing);}
me.CURR_BILL_DATA.tax_percentage=tax_percentage;if(getDataBilling.billing_id!=''){var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/updatePPN?_dc='+d.getTime(),method:'POST',params:{billing_id:getDataBilling.billing_id,tax_percentage:tax_percentage,tax_total:tax_total},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{me.CURR_BILL_DATA.tax_total=rsp.tax_total;me.doClose(me.id+'_changePPN');if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;if(rsp.billingData.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}
if(rsp.billingData.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}
if(rsp.billingData.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}}
me.calcBillingTotal();}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});}}},verify_setDiscount_perBilling_billingCashier:function(is_clear){var me=this;var phpJs=me.app.getHelper('phpJs');var form=Ext.getCmp('form_payBilling').getForm();var discount_id_old=form.findField('discount_id').getValue();var form2=Ext.getCmp('form_setDiscount_perBilling_billingCashier').getForm();var discount_id=form2.findField('discount_id').getValue();var discount_notes=form2.findField('discount_notes').getValue();var discount_percentage=form2.findField('discount_percentage').getValue();var discount_price=form2.findField('discount_price').getValue();var voucher_no=form2.findField('voucher_no').getValue();var min_total_billing=parseFloat(form2.findField('min_total_billing').getValue());var discount_max_price=parseFloat(form2.findField('discount_max_price').getValue());if(!is_clear){is_clear=0;}
if(is_clear==1){discount_id=0;discount_notes='';discount_percentage=0;discount_price=0;min_total_billing=0;voucher_no='';}else{if(voucher_no==''){ExtApp.Msg.warning("Please Insert Discount/Voucher No!");return false;}}
var grand_total=parseFloat(form.findField('grand_total').getValue());if(min_total_billing>0){if(grand_total<min_total_billing){ExtApp.Msg.warning("Min. Total Billing = "+phpJs.priceFormat(min_total_billing));return false;}}
if(form2.isValid()||is_clear==1){if(is_clear==0){if(voucher_no==''||voucher_no==0){ExtApp.Msg.warning("Please Insert Discount/Voucher No!");return false;}}
var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
if(me.CURR_BILL_DATA.discount_perbilling==0&&me.CURR_BILL_DATA.discount_id!=0){if(is_clear==0){ExtApp.Msg.warning("Billing Has Discount Per-Item!<br/>Please clear discount");return;}}
var myMask=new Ext.LoadMask(Ext.getCmp('form_setDiscount_perBilling_billingCashier'),{msg:"Loading..."});myMask.show();var total_billing=parseFloat(getDataBilling.total_billing);discount_percentage=parseFloat(discount_percentage);discount_price=parseFloat(discount_price);var discount_total=0;if(discount_percentage>0){discount_total=parseFloat((discount_percentage/100)*total_billing);discount_total=phpJs.number_format(discount_total,0,'.','');}else{discount_total=discount_price;}
if(discount_percentage==0&&discount_price>0){discount_max_price=discount_price;}else{if(discount_max_price>0){if(discount_total>discount_max_price){alert('Discount Max is '+phpJs.priceFormat(discount_max_price));discount_price=discount_max_price;discount_total=discount_max_price;}}}
me.CURR_BILL_DATA.discount_id=discount_id;me.CURR_BILL_DATA.discount_notes=discount_notes;me.CURR_BILL_DATA.discount_percentage=discount_percentage;me.CURR_BILL_DATA.discount_price=discount_price;me.CURR_BILL_DATA.min_total_billing=min_total_billing;me.CURR_BILL_DATA.discount_perbilling=1;me.CURR_BILL_DATA.voucher_no=voucher_no;var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/updateDiscount?_dc='+d.getTime(),method:'POST',params:{billing_id:getDataBilling.billing_id,discount_id:discount_id,discount_notes:discount_notes,discount_percentage:discount_percentage,discount_price:discount_price,discount_total:discount_total,discount_perbilling:1,voucher_no:voucher_no},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{if(is_clear==1){Ext.getCmp('discount_name_setDiscount_perBilling_billingCashier').select('');}
form.findField('discount_id').setValue(discount_id);form.findField('discount_notes').setValue(discount_notes);form.findField('discount_percentage').setValue(discount_percentage);form.findField('discount_price').setValue(discount_price);form.findField('min_total_billing').setValue(min_total_billing);form.findField('discount_total').setValue(rsp.discount_total);me.CURR_BILL_DATA.discount_total=rsp.discount_total;me.CURR_BILL_DATA.discount_perbilling=1;me.CURR_BILL_DATA.voucher_no=rsp.voucher_no;if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;if(rsp.billingData.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}
if(rsp.billingData.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}
if(rsp.billingData.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}}
me.calcBillingTotal();if(is_clear==0){}
me.doClose(me.id+'_setDiscountBilling');}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});}},verify_setCompliment_billingCashier:function(is_clear){var me=this;var phpJs=me.app.getHelper('phpJs');var supervisor=me.app.getHelper('supervisor');var form=Ext.getCmp('form_payBilling').getForm();var form2=Ext.getCmp('form_setCompliment_billingCashier').getForm();var saveButn_compliment=me.id+'_setCompliment_save';var verifySpvData={title:'Set Compliment Item',verifyMode:0,access:'set_compliment_item',log:1,data:'Set Compliment Item',spvId:me.id+'_setCompliment_spv',saveBtn:saveButn_compliment};if(is_clear==1){saveButn_compliment=me.id+'_setCompliment_clear';var verifySpvData={title:'Clear Compliment Item',verifyMode:0,access:'clear_compliment_item',log:1,data:'Clear Compliment Item',spvId:me.id+'_setCompliment_spv',saveBtn:saveButn_compliment};}
var get_access_spv=-1;if(!opt_spv_access_active){get_access_spv=-1;}else{if(is_clear==1){get_access_spv=opt_spv_access_active.indexOf("clear_compliment_item");}else{get_access_spv=opt_spv_access_active.indexOf("set_compliment_item");}}
if(get_access_spv==-1){me.save_setCompliment_billingCashier(is_clear);}else{supervisor.login(verifySpvData,me);}},save_setCompliment_billingCashier:function(is_clear){var me=this;var phpJs=me.app.getHelper('phpJs');var form=Ext.getCmp('form_payBilling').getForm();var form2=Ext.getCmp('form_setCompliment_billingCashier').getForm();if(!is_clear){is_clear=0;}
if(is_clear==1){}
var myMask=new Ext.LoadMask(Ext.getCmp('form_setCompliment_billingCashier'),{msg:"Loading..."});myMask.show();var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
var getSelection=Ext.getCmp('grid_billingCashier_billingDetail_compliment').getSelectionModel().selected;var compliment_var={allID:[],allName:''};for(x in getSelection.items){if(compliment_var.allID==''){compliment_var.allID=getSelection.items[x].data.id;}else{compliment_var.allID+=','+getSelection.items[x].data.id;}}
var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/updateCompliment?_dc='+d.getTime(),method:'POST',params:{billing_id:getDataBilling.billing_id,is_clear:is_clear,detail_id:compliment_var.allID},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{me.store_billingCashierDetail_compliment.load();if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;form.findField('compliment_total').setValue(rsp.compliment_total);form.findField('total_compliment_rp').setValue(rsp.compliment_total_show);if(rsp.billingData.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}
if(rsp.billingData.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}
if(rsp.billingData.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}}
me.load_store_billingCashierDetail();me.calcBillingTotal();}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});},verify_setDiscount_billingCashier:function(is_clear){var me=this;var phpJs=me.app.getHelper('phpJs');var form=Ext.getCmp('form_payBilling').getForm();var discount_id_old=form.findField('discount_id').getValue();var form2=Ext.getCmp('form_setDiscount_billingCashier').getForm();var discount_id=form2.findField('discount_id').getValue();var discount_notes=form2.findField('discount_notes').getValue();var discount_percentage=form2.findField('discount_percentage').getValue();var discount_price=form2.findField('discount_price').getValue();var min_total_billing=parseFloat(form2.findField('min_total_billing').getValue());var voucher_no=form2.findField('voucher_no').getValue();if(!is_clear){is_clear=0;}
if(is_clear==1){discount_id=0;discount_notes='';discount_percentage=0;discount_price=0;min_total_billing=0;voucher_no='';}
var grand_total=parseFloat(form.findField('grand_total').getValue());if(min_total_billing>0){if(grand_total<min_total_billing){ExtApp.Msg.warning("Min. Total Billing = "+phpJs.priceFormat(min_total_billing));return false;}}
if(form2.isValid()||is_clear==1){var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
if(me.CURR_BILL_DATA.discount_perbilling==1&&me.CURR_BILL_DATA.discount_id!=0){if(is_clear==0){ExtApp.Msg.warning("Billing Has Discount Per-Billing!<br/>Please clear discount first");return;}}
var myMask=new Ext.LoadMask(Ext.getCmp('form_setDiscount_billingCashier'),{msg:"Loading..."});myMask.show();var total_billing=parseFloat(getDataBilling.total_billing);discount_percentage=parseFloat(discount_percentage);discount_price=parseFloat(discount_price);var discount_total=0;if(discount_percentage>0){discount_total=parseFloat((discount_percentage/100)*total_billing);}else{discount_total=discount_price;}
me.CURR_BILL_DATA.discount_id=discount_id;me.CURR_BILL_DATA.discount_notes=discount_notes;me.CURR_BILL_DATA.discount_percentage=discount_percentage;me.CURR_BILL_DATA.discount_price=discount_price;me.CURR_BILL_DATA.min_total_billing=min_total_billing;me.CURR_BILL_DATA.discount_perbilling=0;me.CURR_BILL_DATA.voucher_no=voucher_no;var getSelection=Ext.getCmp('grid_billingCashier_billingDetail_discount').getSelectionModel().selected;var discount_var={allID:[],allName:''};for(x in getSelection.items){if(discount_var.allID==''){discount_var.allID=getSelection.items[x].data.id;}else{discount_var.allID+=','+getSelection.items[x].data.id;}}
var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/updateDiscount?_dc='+d.getTime(),method:'POST',params:{billing_id:getDataBilling.billing_id,discount_id:discount_id,discount_notes:discount_notes,discount_percentage:discount_percentage,discount_price:discount_price,discount_total:discount_total,discount_perbilling:0,voucher_no:voucher_no,detail_id:discount_var.allID},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{if(is_clear==1){Ext.getCmp('discount_name_setDiscount_billingCashier').select('');}
form.findField('discount_id').setValue(discount_id);form.findField('discount_notes').setValue(discount_notes);form.findField('discount_percentage').setValue(discount_percentage);form.findField('discount_price').setValue(discount_price);form.findField('min_total_billing').setValue(min_total_billing);form.findField('discount_total').setValue(rsp.discount_total);me.store_billingCashierDetail_discount.proxy.extraParams.discount_id=0;me.store_billingCashierDetail_discount.load();me.CURR_BILL_DATA.discount_total=rsp.discount_total;me.CURR_BILL_DATA.discount_perbilling=0;if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;if(rsp.billingData.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}
if(rsp.billingData.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}
if(rsp.billingData.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}}
me.calcBillingTotal();me.doClose(me.id+'_setDiscount');}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});}},verify_changeService_billingCashier:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var supervisor=me.app.getHelper('supervisor');var form=Ext.getCmp('form_payBilling').getForm();var service_percentage_old=form.findField('service_percentage').getValue();var form2=Ext.getCmp('form_changeService_billingCashier').getForm();var service_percentage_new=form2.findField('change_service_percentage').getValue();var verifySpvData={title:'Change Service',verifyMode:0,access:'change_service',log:1,data:'Change Service (%) from '+service_percentage_old+' to '+service_percentage_new,spvId:me.id+'_changeService_spv',saveBtn:me.id+'_changeService_save'};var get_access_spv=-1;if(!opt_spv_access_active){get_access_spv=-1;}else{get_access_spv=opt_spv_access_active.indexOf("change_service");}
if(get_access_spv==-1){me.save_changeService_billingCashier();}else{supervisor.login(verifySpvData,me);}},save_changeService_billingCashier:function(){var me=this;var me=this;var phpJs=me.app.getHelper('phpJs');var form=Ext.getCmp('form_changeService_billingCashier').getForm();if(form.isValid()){var myMask=new Ext.LoadMask(Ext.getCmp('form_changeService_billingCashier'),{msg:"Loading..."});myMask.show();var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
var total_billing=parseFloat(getDataBilling.total_billing);var service_percentage=form.findField('change_service_percentage').getValue();service_percentage=parseFloat(service_percentage);var service_total=0;if(service_percentage>0){service_total=parseFloat((service_percentage/100)*total_billing);}
me.CURR_BILL_DATA.service_percentage=service_percentage;if(getDataBilling.billing_id!=''){var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/updateService?_dc='+d.getTime(),method:'POST',params:{billing_id:getDataBilling.billing_id,service_percentage:service_percentage,service_total:service_total},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{me.CURR_BILL_DATA.service_total=rsp.service_total;me.doClose(me.id+'_changeService');if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;if(rsp.billingData.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}
if(rsp.billingData.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}
if(rsp.billingData.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}}
me.calcBillingTotal();}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});}}},verify_changeDP_billingCashier:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var supervisor=me.app.getHelper('supervisor');var form=Ext.getCmp('form_payBilling').getForm();var total_dp_old=form.findField('total_dp').getValue();var form2=Ext.getCmp('form_changeDP_billingCashier').getForm();var total_dp_new=form2.findField('change_total_dp').getValue();var verifySpvData={title:'Change Down Payment (DP)',verifyMode:0,access:'change_dp',log:1,data:'Change Down Payment (DP) from '+total_dp_old+' to '+total_dp_new,spvId:me.id+'_changeDP_spv',saveBtn:me.id+'_changeDP_save'};var get_access_spv=-1;if(!opt_spv_access_active){get_access_spv=-1;}else{get_access_spv=opt_spv_access_active.indexOf("change_dp");}
if(get_access_spv==-1){me.save_changeDP_billingCashier();}else{supervisor.login(verifySpvData,me);}},save_changeDP_billingCashier:function(){var me=this;var me=this;var phpJs=me.app.getHelper('phpJs');var form=Ext.getCmp('form_changeDP_billingCashier').getForm();if(form.isValid()){var myMask=new Ext.LoadMask(Ext.getCmp('form_changeDP_billingCashier'),{msg:"Loading..."});myMask.show();var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
var total_billing=parseFloat(getDataBilling.total_billing);var total_dp=form.findField('change_total_dp').getValue();total_dp=parseFloat(total_dp);me.CURR_BILL_DATA.total_dp=total_dp;if(getDataBilling.billing_id!=''){var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/updateDP?_dc='+d.getTime(),method:'POST',params:{billing_id:getDataBilling.billing_id,total_dp:total_dp},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{me.doClose(me.id+'_changeDP');if(rsp.billingData){me.CURR_BILL_DATA=rsp.billingData;me.data_billing=rsp.billingData;if(rsp.billingData.billing_status=='unpaid'){Ext.getCmp("grid_billingCashier_activeBilling").store.load();}
if(rsp.billingData.billing_status=='hold'){Ext.getCmp("grid_billingCashier_holdBilling").store.load();}
if(rsp.billingData.billing_status=='paid'){Ext.getCmp("grid_billingCashier_paidBilling").store.load();}}
me.calcBillingTotal();}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});}}},verify_returOrder_billingCashier:function(is_cancel){var me=this;var phpJs=me.app.getHelper('phpJs');var supervisor=me.app.getHelper('supervisor');var form=Ext.getCmp('form_returOrder_billingCashier').getForm();var dtRetur=me.returOrderData;var dtReturQty=form.findField('retur_qty').getValue();var is_cancelReturOrder=form.findField('is_cancelReturOrder').getValue();if(form.isValid()){var dtVerify='Retur Order: '+dtRetur.product_name+', Qty: '+dtReturQty+' from '+dtRetur.order_qty;if(is_cancelReturOrder==1){dtVerify='Cancel/Reset Retur';}
if(dtReturQty>dtRetur.order_qty){ExtApp.Msg.warning('Max Qty is '+dtRetur.order_qty);return false;}else{var verifySpvData={title:'Retur Order',verifyMode:0,access:'retur_order',log:1,data:dtVerify,spvId:me.id+'_returOrder_spv',saveBtn:me.id+'_returOrder_save'};var get_access_spv=-1;if(!opt_spv_access_active){get_access_spv=-1;}else{get_access_spv=opt_spv_access_active.indexOf("retur_order");}
if(get_access_spv==-1){me.save_returOrder_billingCashier();}else{supervisor.login(verifySpvData,me);}}}},save_returOrder_billingCashier:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var form=Ext.getCmp('form_returOrder_billingCashier').getForm();if(form.isValid()){var myMask=new Ext.LoadMask(Ext.getCmp('form_returOrder_billingCashier'),{msg:"Loading..."});myMask.show();var dtRetur=me.returOrderData;var billing_detail_id=dtRetur.id;if(dtRetur.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
if(billing_detail_id==''){ExtApp.Msg.warning("Order Item Unidentified!");return;}
var billing_detail_id=form.findField('billing_detail_id').getValue();var retur_type_group=Ext.getCmp('retur_type_group').getChecked();var retur_qty=form.findField('retur_qty').getValue();var retur_reason=form.findField('retur_reason').getValue();var is_cancel=form.findField('is_cancelReturOrder').getValue();var retur_type=retur_type_group[0].inputValue;if(is_cancel==1){retur_type='none';retur_qty=0;retur_reason='';}
if(billing_detail_id!=''){var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/returOrder?_dc='+d.getTime(),method:'POST',params:{billing_id:dtRetur.billing_id,billing_detail_id:billing_detail_id,retur_type:retur_type,retur_qty:retur_qty,retur_reason:retur_reason},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{me.doClose(me.id+'_returOrder');}
me.load_store_billingCashierDetail();myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});}}},save_mergeBill_billingCashier:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var form=Ext.getCmp('form_mergeBill_billingCashier').getForm();if(form.isValid()){var myMask=new Ext.LoadMask(Ext.getCmp('form_mergeBill_billingCashier'),{msg:"Loading..."});myMask.show();var getSelection=Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().selected;var merge_var={allID:'',allName:''};for(x in getSelection.items){if(merge_var.allID==''){merge_var.allID=getSelection.items[x].data.id;}else{merge_var.allID+=','+getSelection.items[x].data.id;}}
var main_billing_id=form.findField('main_billing_id').getValue();if(main_billing_id!=''){var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/mergeBill?_dc='+d.getTime(),method:'POST',params:{main_billing_id:main_billing_id,merge_billing_id:merge_var.allID},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{me.doClose(me.id+'_mergeBill');Ext.getCmp("grid_billingCashier_holdBilling").store.load({callback:function(){Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().select(0);}});me.load_store_billingCashierDetail('mergeBill');}
myMask.hide();},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);myMask.hide();}});}}},save_unMergeBill_billingCashier:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var getSelection=Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().selected;if(getSelection.length>1){ExtApp.Msg.warning("Please Select only 1 Billing to UnMerge Billing..");return false;}
var getUnMergeBilling='';var getMergeId='';for(x in getSelection.items){if(getSelection.items[x].data.merge_id!=''&&getSelection.items[x].data.billing_no!=''){getUnMergeBilling=getSelection.items[x].data.billing_no;getMergeId=getSelection.items[x].data.merge_id;}else{ExtApp.Msg.warning("Cannot UnMerge Billing..");return false;}}
var d=new Date();Ext.Ajax.request({waitMsg:'Loading...',url:appUrl+'cashier/billingCashier/unMergeBill?_dc='+d.getTime(),method:'POST',params:{main_billing_id:getMergeId},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{Ext.getCmp("grid_billingCashier_holdBilling").store.load({callback:function(){Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().select(0);}});me.load_store_billingCashierDetail('unMergeBill');}},failure:function(response,options){var rsp=Ext.decode(response.responseText);ExtApp.Msg.warning(rsp.info);}});},verify_unMergeBill_billingCashier:function(){var me=this;var phpJs=me.app.getHelper('phpJs');var supervisor=me.app.getHelper('supervisor');var getSelection=Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().selected;if(getSelection.length>1){ExtApp.Msg.warning("Please Select only 1 Billing to UnMerge Billing..");return false;}
var getUnMergeBilling='';var getMergeId='';for(x in getSelection.items){if(getSelection.items[x].data.merge_id!=''&&getSelection.items[x].data.billing_no!=''){getUnMergeBilling=getSelection.items[x].data.billing_no;getMergeId=getSelection.items[x].data.merge_id;}else{ExtApp.Msg.warning("Cannot UnMerge Billing..");return false;}}
if(getUnMergeBilling!=''){ExtApp.Msg.confirm('UnMerge Billing #'+getUnMergeBilling+'?',false,function(btn){if(btn=='yes'){var verifySpvData={title:'UnMerge Billing',verifyMode:0,access:'unmerge_billing',log:1,data:'UnMerge Billing: #'+getUnMergeBilling,saveBtn:'billingCashier_unMergeBill_save'};var get_access_spv=-1;if(!opt_spv_access_active){get_access_spv=-1;}else{get_access_spv=opt_spv_access_active.indexOf("unmerge_billing");}
if(get_access_spv==-1){me.save_unMergeBill_billingCashier();}else{supervisor.login(verifySpvData,me);}}});}else{ExtApp.Msg.warning("Cannot UnMerge Billing..");return false;}},save_orderProduct_split:function(){var me=this;var form=Ext.getCmp('form_orderProduct_split').getForm();if(me.save_progress_orderProduct_split){ExtApp.Msg.warning('Please wait..<br/>Order Product/Menu on Progress');return false;}
me.save_progress_orderProduct_split=true;var phpJs=me.app.getHelper('phpJs');if(form.isValid()){var data_order_id=form.findField('id').getValue();var billing_id=form.findField('billing_id').getValue();var order_qty=form.findField('order_qty').getValue();var order_qty_split=form.findField('order_qty_split').getValue();if(order_qty_split>order_qty){me.save_progress_orderProduct_split=false;ExtApp.Msg.warning('Cannot Set Split Qty > Order Qty<br/>Max: '+order_qty);return false;}
me.doClose(me.id+'_orderProduct_split');var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail_split'),{msg:"Saving Split Order..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Split Order ...',url:appUrl+'cashier/billingCashier/save_orderProduct_split?_dc='+d.getTime(),method:'POST',params:{id:data_order_id,billing_id:billing_id,order_qty:order_qty,order_qty_split:order_qty_split},success:function(response,options){myMask.hide();me.save_progress_orderProduct_split=false;me.doClose(me.id+'_orderProduct_split');me.store_billingCashierDetail_split.load();},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Save Failed, '+rsp.info);myMask.hide();me.save_progress_orderProduct_split=false;}});}else{me.save_progress_orderProduct_split=false;}},save_splitBill_billingCashier:function(){var me=this;if(!me.data_split_id){ExtApp.Msg.warning("Cannot Split Billing, ID not identified!");return false;}
if(me.save_progress_splitBill){ExtApp.Msg.warning('Please wait..<br/>Split Billing on Progress');return false;}
me.save_progress_splitBill=true;var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail_split'),{msg:"Saving Split Billing..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Split Billing ...',url:appUrl+'cashier/billingCashier/save_splitBill?_dc='+d.getTime(),method:'POST',params:{billing_id:me.data_split_id},success:function(response,options){me.save_progress_splitBill=false;var rsp=Ext.decode(response.responseText);if(rsp.success==false){myMask.hide();ExtApp.Msg.warning(rsp.info);}else{me.doClose(me.id+'_splitBill');myMask.hide();Ext.getCmp("grid_billingCashier_holdBilling").store.load({callback:function(){Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().deselectAll();Ext.getCmp('grid_billingCashier_holdBilling').getSelectionModel().select(0);}});me.load_store_billingCashierDetail('splitBill');}},failure:function(response,options){me.save_progress_splitBill=false;var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Save Failed, '+rsp.info);myMask.hide();}});},printMultipleQC_printBilling:function(from_source_tipe){var me=this;if(from_source_tipe==7){from_source_tipe=2;}
var getDataBilling=me.CURR_BILL_DATA;if(getDataBilling.billing_id==''){ExtApp.Msg.warning("Billing Unidentified!");return;}
if(!getDataBilling.table_id){getDataBilling.table_id=0;}
if(getDataBilling.table_id==''||getDataBilling.table_id==0){ExtApp.Msg.warning("Table Unidentified!");return;}
if(getDataBilling.total_guest==0){ExtApp.Msg.warning("Total Guest Cannot Empty!");return;}
var d=new Date();Ext.Ajax.request({waitMsg:'Print Multiple QC ...',url:appUrl+'cashier/billingCashier/print_MultipleQC?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{var no=0;var total_printer=parseFloat(rsp.total_printer);if(total_printer>0){for(x in rsp.data_printer){no++;var timerPrint=1000*no;var getIdPrinter=rsp.data_printer[x].option_value;if(parseFloat(getIdPrinter)>0){me.printReceipt_printBilling(from_source_tipe,getIdPrinter);}}
timerPrint+=500;if(opt_print_qc_then_order=='1'){setTimeout(function(){me.printReceipt_printBilling(6);},1000);}}else{ExtApp.Msg.warning('No Printer QC been added for Multiple QC!');}}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Save Failed, '+rsp.info);}});},printMultipleBilling_printBilling:function(from_source_tipe,getDataBilling){var me=this;var d=new Date();Ext.Ajax.request({waitMsg:'Print Multiple Billing ...',url:appUrl+'cashier/billingCashier/print_MultipleBilling?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){var rsp=Ext.decode(response.responseText);if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{var no=0;var total_printer=parseFloat(rsp.total_printer);if(total_printer>0){for(x in rsp.data_printer){no++;var timerPrint=1000*no;var getIdPrinter=rsp.data_printer[x].option_value;if(parseFloat(getIdPrinter)>0){me.printReceipt_printBilling(from_source_tipe,getIdPrinter,getDataBilling);}}
timerPrint+=500;}else{ExtApp.Msg.warning('No Printer Billing been added for Multiple Billing!');}}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Save Failed, '+rsp.info);}});},verify_voucher_setDiscount_perItem_billingCashier:function(){var me=this;var form=Ext.getCmp('form_setDiscount_billingCashier').getForm();var get_voucher_no=form.findField('voucher_no').getValue();if(get_voucher_no!=''){var myMask=new Ext.LoadMask(Ext.getCmp('grid_billingCashier_billingDetail_discount'),{msg:"Verify Voucher..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Verify ...',url:appUrl+'master_pos/voucherList/verifyVoucher?_dc='+d.getTime(),method:'POST',params:{tipe:'item',voucher_no:get_voucher_no,billing_no:me.CURR_BILL_DATA.billing_no},success:function(response,options){var rsp=Ext.decode(response.responseText);myMask.hide();if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{form.findField('discount_id').setValue(rsp.data.discount_id);form.findField('discount_notes').setValue(rsp.data.discount_name);form.findField('discount_percentage').setValue(rsp.data.discount_percentage);form.findField('discount_price').setValue(rsp.data.discount_price);form.findField('min_total_billing').setValue(rsp.data.min_total_billing);Ext.getCmp('discount_name_setDiscount_billingCashier').select(rsp.data.discount_name);me.store_billingCashierDetail_discount.proxy.extraParams.discount_id=rsp.data.discount_id;me.store_billingCashierDetail_discount.proxy.extraParams.billing_id=me.CURR_BILL_DATA.billing_id;me.store_billingCashierDetail_discount.load({callback:function(){}});}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Verify Failed, '+rsp.info);myMask.hide();}});}},verify_voucher_setDiscount_perBilling_billingCashier:function(){var me=this;var form=Ext.getCmp('form_setDiscount_perBilling_billingCashier').getForm();var get_voucher_no=form.findField('voucher_no').getValue();var theApp=me.app;var phpJs=theApp.getHelper('phpJs');if(get_voucher_no!=''){var myMask=new Ext.LoadMask(Ext.getCmp('form_setDiscount_perBilling_billingCashier'),{msg:"Verify Voucher..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Verify ...',url:appUrl+'master_pos/voucherList/verifyVoucher?_dc='+d.getTime(),method:'POST',params:{tipe:'billing',voucher_no:get_voucher_no,billing_no:me.CURR_BILL_DATA.billing_no},success:function(response,options){var rsp=Ext.decode(response.responseText);myMask.hide();if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{form.findField('discount_id').setValue(rsp.data.discount_id);form.findField('discount_notes').setValue(rsp.data.discount_name);form.findField('discount_percentage').setValue(rsp.data.discount_percentage);form.findField('discount_price').setValue(rsp.data.discount_price);form.findField('discount_price_show').setValue('Rp '+phpJs.priceFormat(rsp.data.discount_price));form.findField('min_total_billing').setValue(rsp.data.min_total_billing);form.findField('discount_max_price').setValue(rsp.data.discount_max_price);Ext.getCmp('discount_name_setDiscount_perBilling_billingCashier').select(rsp.data.discount_name);me.store_billingCashierDetail_discount.proxy.extraParams.discount_id=rsp.data.discount_id;me.store_billingCashierDetail_discount.proxy.extraParams.billing_id=me.CURR_BILL_DATA.billing_id;me.store_billingCashierDetail_discount.load({callback:function(){}});}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Verify Failed, '+rsp.info);myMask.hide();}});}},BGverify_orderProduct:function(){var me=this;var form=Ext.getCmp('form_orderProduct').getForm();var get_buyget_id=form.findField('buyget_id').getValue();var get_product_id=form.findField('product_id').getValue();var get_order_qty=form.findField('order_qty').getValue();var get_buyget_tipe=form.findField('buyget_tipe').getValue();var theApp=me.app;var phpJs=theApp.getHelper('phpJs');if(get_buyget_id!=''){var myMask=new Ext.LoadMask(Ext.getCmp('form_orderProduct'),{msg:"Verify..."});myMask.show();var d=new Date();Ext.Ajax.request({waitMsg:'Verify ...',url:appUrl+'master_pos/buygetList/verifyBuyget?_dc='+d.getTime(),method:'POST',params:{buyget_id:get_buyget_id,product_id:get_product_id,order_qty:get_order_qty,buyget_tipe:get_buyget_tipe},success:function(response,options){var rsp=Ext.decode(response.responseText);myMask.hide();if(rsp.success==false){ExtApp.Msg.warning(rsp.info);}else{if(get_buyget_tipe=='percentage'){form.findField('buyget_percentage').setValue(rsp.get_percentage);form.findField('buyget_qty').setValue(0);}
if(get_buyget_tipe=='item'){if(rsp.get_varian_item==1){form.findField('buyget_qty').setValue(rsp.get_qty);}else{form.findField('buyget_qty').setValue(rsp.get_qty);}}}},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Verify Failed, '+rsp.info);myMask.hide();}});}},printSettlement:function(printSetting){var d=new Date();Ext.Ajax.request({waitMsg:'Print Settlement...',url:appUrl+'cashier/billingCashier/printSettlement?_dc='+d.getTime(),method:'POST',params:{},success:function(response,options){},failure:function(response,options){var rsp=Ext.decode(response.responseText);if(!rsp.info){rsp.info='';}
ExtApp.Msg.error('Print Failed, '+rsp.info);}});}});